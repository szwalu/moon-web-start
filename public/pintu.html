<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>高级拼图工具</title>
  <style>
    body {
      font-family: sans-serif;
      background: #fff;
      margin: 0;
      padding: 20px;
    }
    h2 { text-align: center; }
    #upload-area {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    #upload-area.dragover { background: #e0f0ff; }
    #thumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .thumb {
      width: 80px;
      height: 80px;
      border: 2px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #controls {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    canvas {
      width: 100%;
      max-width: 720px;
      display: block;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
    }
    label {
      font-size: 14px;
      display: block;
      margin-bottom: 4px;
    }
    select, input[type="number"], input[type="color"] {
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
    button {
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>高级拼图生成器</h2>
<div id="upload-area">拖拽图片到这里或点击上传</div>
<input type="file" id="upload" accept="image/*" multiple style="display:none;" />
<div id="thumbs"></div>

<div id="controls">
  <div>
    <label>布局样式</label>
    <select id="layout">
      <option value="3x3">3×3 九宫格</option>
      <option value="2x2">2×2 四宫图</option>
      <option value="1x3">1+3 左大右三</option>
      <option value="2x1">2×1</option>
      <option value="2x3">2×3</option>
      <option value="3x2">3×2</option>
      <option value="2x4">2×4</option>
      <option value="2+3">左2+右3</option>
      <option value="3+4">左3+右4</option>
    </select>
  </div>
  <div>
    <label>边框宽度（px）</label>
    <input type="number" id="borderW" value="4" min="0">
  </div>
  <div>
    <label>边框颜色</label>
    <input type="color" id="borderC" value="#ffffff">
  </div>
  <div>
    <label>圆角（px）</label>
    <input type="number" id="radius" value="8" min="0">
  </div>
  <div>
    <label>间距（px）</label>
    <input type="number" id="gap" value="4" min="0">
  </div>
  <div>
    <label>输出尺寸（px）</label>
    <select id="size">
      <option value="1080">1080</option>
      <option value="1440">1440</option>
      <option value="1920">1920</option>
    </select>
  </div>
  <div style="align-self: end;">
    <button id="download">下载</button>
  </div>
</div>

<canvas id="canvas" width="1080" height="1080"></canvas>

<script>
const uploadArea = document.getElementById('upload-area');
const upload = document.getElementById('upload');
const thumbs = document.getElementById('thumbs');
const layoutEl = document.getElementById('layout');
const borderWEl = document.getElementById('borderW');
const borderCEl = document.getElementById('borderC');
const radiusEl = document.getElementById('radius');
const gapEl = document.getElementById('gap');
const sizeEl = document.getElementById('size');
const dlBtn = document.getElementById('download');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let imgs = [];

function addThumbnail(img) {
  const div = document.createElement('div');
  div.classList.add('thumb');
  const image = new Image();
  image.src = img.src;
  div.appendChild(image);
  thumbs.appendChild(div);
}

uploadArea.addEventListener('click', () => upload.click());
uploadArea.addEventListener('dragover', e => {
  e.preventDefault(); uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', e => {
  e.preventDefault(); uploadArea.classList.remove('dragover');
});
uploadArea.addEventListener('drop', e => {
  e.preventDefault(); uploadArea.classList.remove('dragover');
  upload.files = e.dataTransfer.files;
  handleFiles();
});
upload.addEventListener('change', handleFiles);

function handleFiles() {
  thumbs.innerHTML = '';
  imgs = [];
  Array.from(upload.files).forEach(file => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.src = url;
    img.onload = () => {
      imgs.push(img);
      addThumbnail(img);
      generate();
    };
  });
}

function drawCoverImage(img, x, y, w, h, radius = 0) {
  const imgRatio = img.width / img.height;
  const frameRatio = w / h;
  let drawW, drawH;
  if (imgRatio > frameRatio) {
    drawH = h;
    drawW = h * imgRatio;
  } else {
    drawW = w;
    drawH = w / imgRatio;
  }
  const offsetX = x - (drawW - w) / 2;
  const offsetY = y - (drawH - h) / 2;

  ctx.save();
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.arcTo(x + w, y, x + w, y + radius, radius);
  ctx.arcTo(x + w, y + h, x + w - radius, y + h, radius);
  ctx.arcTo(x, y + h, x, y + h - radius, radius);
  ctx.arcTo(x, y, x + radius, y, radius);
  ctx.clip();
  ctx.drawImage(img, offsetX, offsetY, drawW, drawH);
  ctx.restore();
}

function generate() {
  if (imgs.length === 0) return;
  const size = +sizeEl.value;
  canvas.width = canvas.height = size;
  const layout = layoutEl.value;
  const borderW = +borderWEl.value;
  const borderC = borderCEl.value;
  const radius = +radiusEl.value;
  const gap = +gapEl.value;

  ctx.fillStyle = borderC;
  ctx.fillRect(0, 0, size, size);

  if (layout === '1x3' && imgs.length >= 4) {
    const bigW = size * 0.6 - gap;
    const smallW = (size * 0.4 - gap * 2) / 1;
    const smallH = (size - gap * 2) / 3;
    drawCoverImage(imgs[0], borderW, borderW, bigW, size - borderW * 2, radius);
    for (let i = 1; i <= 3; i++) {
      const y = borderW + (i - 1) * (smallH + gap);
      drawCoverImage(imgs[i], bigW + gap * 2, y, smallW, smallH, radius);
    }
    return;
  }

  if (layout === '2+3' && imgs.length >= 5) {
    const colW = (size - gap * 3) / 3;
    const colH = (size - gap) / 1;
    drawCoverImage(imgs[0], borderW, borderW, colW, colH, radius);
    drawCoverImage(imgs[1], colW + gap * 2, borderW, colW, colH, radius);
    const smallH = (size - gap * 2) / 3;
    for (let i = 2; i <= 4; i++) {
      drawCoverImage(imgs[i], colW * 2 + gap * 3, borderW + (i - 2) * (smallH + gap), colW, smallH, radius);
    }
    return;
  }

  if (layout === '3+4' && imgs.length >= 7) {
    const colW = (size - gap * 4) / 4;
    const colH = size - borderW * 2;
    for (let i = 0; i < 3; i++) {
      drawCoverImage(imgs[i], borderW + i * (colW + gap), borderW, colW, colH, radius);
    }
    const smallH = (size - gap * 3) / 4;
    for (let i = 3; i < 7; i++) {
      drawCoverImage(imgs[i], borderW + 3 * (colW + gap), borderW + (i - 3) * (smallH + gap), colW, smallH, radius);
    }
    return;
  }

  let cols = 3, rows = 3;
  if (layout === '2x2') { cols = 2; rows = 2; }
  else if (layout === '2x1') { cols = 2; rows = 1; }
  else if (layout === '2x3') { cols = 2; rows = 3; }
  else if (layout === '3x2') { cols = 3; rows = 2; }
  else if (layout === '2x4') { cols = 2; rows = 4; }
  else if (layout === '3x3') { cols = 3; rows = 3; }

  const cellW = (size - borderW * 2 - gap * (cols - 1)) / cols;
  const cellH = (size - borderW * 2 - gap * (rows - 1)) / rows;

  for (let i = 0; i < imgs.length && i < cols * rows; i++) {
    const img = imgs[i];
    const x = borderW + (i % cols) * (cellW + gap);
    const y = borderW + Math.floor(i / cols) * (cellH + gap);
    drawCoverImage(img, x, y, cellW, cellH, radius);
  }
}

layoutEl.addEventListener('change', generate);
[borderWEl, borderCEl, radiusEl, gapEl, sizeEl].forEach(el => el.addEventListener('input', generate));

dlBtn.addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = '拼图.jpg'; // 改为 JPG
  link.href = canvas.toDataURL('image/jpeg', 0.92); // 使用高质量 JPEG
  link.click();
});
</script>

</body>
</html>